<!DOCTYPE html >
<html xmlns:th="http://www.thymeleaf.org" lang="en">
    <head>
        <title th:text="${title}"></title>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel='stylesheet' id='google-fonts-css'  href='http://fonts.googleapis.com/css?family=Playfair+Display%7COpen+Sans+Condensed%3A300%7COpen+Sans%7CShadows+Into+Light%7CMuli%7CDroid+Sans%7CArbutus+Slab%7CAbel&#038;ver=3.5.1' type='text/css' media='all' />
        <link rel="stylesheet" media="all" th:href="@{/styles/bootstrap.css}">
        <link rel="stylesheet" media="all" th:href="@{/styles/main.css}">
        <script type="text/javascript" th:src="@{/js/jquery.min.js}"></script>
        <script type="text/javascript" th:src="@{/js/bootstrap.min.js}"></script>
        <!--<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>-->
        <script type="text/javascript" th:src="@{/js/jquery.autocomplete.js}"></script>

    </head>
    <body>
        <script th:inline="javascript">
			/*<![CDATA[*/
			var allPointsString = JSON.parse(/*[[${allPoints}]]*/ "no pints");
			/*]]>*/

        </script>
        <div class="container">
            <!--*** Header ***-->
            <div th:replace="~{fragments/header}"></div>

            <!--*** Map ***-->
            <div id="map" class="mb-3"></div>

            <!--*** Buttons ***-->
            <div class="row mb-3">
                <div class="col-lg-4 mb-3">
                    <a class="btn btn-success btn-lg" th:href="@{/point-create}" role="button">Създай нов обект</a>
                </div>
                <div id="updDellButt" class="col-lg-4" style="display: none;">
                    <a id="edit" class="btn btn-outline-primary"><img th:src="@{/images/edit_20px.png}"><strong> Редактиране обект</strong></a>
                    <a id="delete" class="btn btn-outline-danger" th:href="@{/point-delete}"><img th:src="@{/images/trash_20px.png}"><strong>Изтриване обект</strong></a>
                </div>
                <div id="excPdfButt" class="col-lg-4" style="display: none;">
                    <a id="downlExcel" class="btn btn-outline-success"><img th:src="@{/images/excel_20px.png}"><strong> Свали като EXCEL</strong></a>
                    <a id="downlPdf" class="btn btn-outline-secondary"><img th:src="@{/images/pdf_20px.png}"><strong>Свали като PDF</strong></a>
                </div>
            </div>

            <!--*** Fomr ***-->
            <form>
                <div id="form" class="row" style="display: none;">
                    <div class="col-lg-4 form-group">
                        <div class="card border-primary">
                            <legend class="card-header">Обект</legend>
                            <div class="card-body">
                                <h4 class="card-title">Име</h4>
                                <p id="objName" class="card-text"></p>
                                <h4 class="card-title">ID</h4>
                                <p id="identifier" class="card-text"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 form-group">
                        <div class="card border-primary">
                            <legend class="card-header">Адрес</legend>
                            <div class="card-body">
                                <h4 class="card-title">Населено място</h4>
                                <p id="place" class="card-text"></p>
                                <div class=" input-group-append">
                                    <div class="col-7">
                                        <h4 class="card-title">Улица</h4>
                                        <p id="street" class="card-text"></p>
                                    </div>
                                    <div class="offset-1">
                                        <h5 class="card-title">№</h5>
                                        <p id="number" class="card-text"></p>
                                    </div>
                                    <div class="offset-1">
                                        <h5 class="card-title">Вх.</h5>
                                        <p id="entrance" class="card-text"></p>
                                    </div>
                                    <div class="offset-1">
                                        <h5 class="card-title">Ет.</h5>
                                        <p id="floor" class="card-text"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 form-group">
                        <div class="card border-primary">
                            <legend class="card-header">Контролна платка</legend>
                            <div class="card-body">
                                <h4 class="card-title">Марка</h4>
                                <p id="controlBoardName" class="card-text"></p>
                                <h4 class="card-title">Модел</h4>
                                <p id="controlBoardModel" class="card-text"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <script th:inline="javascript">
			var map;
			var markersOnMap = new Map();
			var autocompletePointId;
			var actionAjax = /*[[@{/point}]]*/ '/point';
			var actionAutocomplete = /*[[@{/search-autocomplete}]]*/ '/search-autocomplete}]';
			var iconBase = '/images/';
			var icons = {
				def: iconBase + "pinDefault.png",
				cur: iconBase + "pinCurrent.png"
			};

			function initMap() {
				map = new google.maps.Map(document.getElementById('map'), {
					center: {lat: 41.562945, lng: 23.2725755}, // sandanski
					zoom: 14,
					styles: [
						{"featureType": "all",
							"elementType": "labels",
							"stylers": [
								{"visibility": "off"}
							]
						},
						{"featureType": "administrative",
							"elementType": "all",
							"stylers": [
								{"visibility": "simplified"},
								{"color": "#5b6571"},
								{"lightness": "35"}]
						},
						{"featureType": "road",
							"elementType": "labels",
							"stylers": [{"visibility": "on"}]},
					]
				});

				allPointsString.point.forEach(function (element) {
					var marker = new google.maps.Marker({
						map: map,
						title: element.name,
						position: new google.maps.LatLng(element.lat, element.lng),
						label: {
							text: element.name.substr(0, 1),
							color: 'white',
							fontFamily: 'Verdana',
							fontWeight: 'bold'},
						icon: {
							url: icons.def,
							labelOrigin: new google.maps.Point(30, 14)
						},

						animation: google.maps.Animation.DROP,
						id: element.id
					});
					markersOnMap.set(element.id, marker);

					google.maps.event.addListener(marker, "click", function () {
						switchIcon(marker);
						ajaxGetPoint(actionAjax, element.id);
						$('#input-search').val("");
					});

					google.maps.event.addListener(marker, "clickable_changed", function () {
						alert(marker.getTitle());
					});

				});

			}
			function switchIcon(marker) {
				markersOnMap.forEach(function (element) {
					if (marker === element) {
						if (element.getIcon().url === icons.def) {
							var icon = {
								url: icons.cur,
								labelOrigin: new google.maps.Point(42, 20)
							};
							element.setIcon(icon);
							var label = {
								text: element.getTitle().substr(0, 1),
								color: "#eb3a44",
								fontSize: "18px",
								fontFamily: 'Verdana',
								fontWeight: "bold"
							};
							element.setLabel(label);
							element.setZIndex(1);
						}
					} else {
						var icon = {
							url: icons.def,
							labelOrigin: new google.maps.Point(30, 14)
						};
						var label = {
							text: element.getLabel().text,
							color: 'white',
							fontFamily: 'Verdana',
							fontWeight: 'bold'}
						element.setIcon(icon);
						element.setLabel(label);
						element.setZIndex(-1);
					}
				});
			}
			function centeringMarker(id) {
				var pos = markersOnMap.get(id).getPosition();
				map.setZoom(16);
				map.panTo(new google.maps.LatLng(pos.lat(), pos.lng()));
			}
			function ajaxGetPoint(url, paramId) {
				centeringMarker(paramId);
				$.ajax({
					method: "GET",
					url: url,
					data: {id: paramId},
					success: function (result) {
						document.getElementById("form").style.display = "flex";
						document.getElementById("updDellButt").style.display = "inline";
						document.getElementById("excPdfButt").style.display = "inline";
						$("#objName").html(result.point.name);
						$("#identifier").html(result.point.identifier);
						$("#place").html(result.point.address.place);
						$("#street").html(result.point.address.street);
						$("#number").html(result.point.address.number);
						$("#entrance").html(result.point.address.entrance);
						$("#floor").html(result.point.address.floor);
						$("#controlBoardName").html(result.point.controlBoard.brand.name);
						$("#controlBoardModel").html(result.point.controlBoard.model);
						$("#edit").attr("href", '/point-edit/' + paramId);
						var delHref = $("#delete").attr("href").valueOf().toString();
						$("#delete").attr("href", delHref.substring(0, 13) + "/" + paramId);
						$("#downlExcel").attr("href", '/point-excel/' + paramId);
						$("#downlPdf").attr("href", '/point-pdf' + paramId);
					},
					error: function () {
					}
				});
			}

			//STRAT Autocomplete for search input
			$(document).ready(function () {
				$('#input-search').autocomplete({
					minChars: 2,
					serviceUrl: actionAutocomplete,
					params: {dataSearch: function () {
							return $('#input-search').val();
						},
						typeSearch: function () {
							return $("input[type='radio'][name='search-radio']:checked").val();
						}},
					noCache: true,
					delimiter: ",",
					onSelect: function (selected) {
						$('#input-search').attr("data", selected.data);
						autocompletePointId = selected.data;
						return false;
					},
					transformResult: function (response) {
						return {
							suggestions: $.map($.parseJSON(response), function (item) {

								return {
									value: item.name,
									data: item.id
								};
							}),

						};
					}
				}).keypress(function (e) {
					var code = (e.keyCode ? e.keyCode : e.which);
					if (code === 13) { //Enter keycode
						if ($('#input-search').val().length > 2) {
							ajaxGetPoint(actionAjax, autocompletePointId);
							switchIcon(markersOnMap.get(autocompletePointId));
							$('#input-search').val("");
						}
						return false;
					}
				});
			});

			$('#button-search').click(function () {
				if ($('#input-search').val().length > 2) {
					ajaxGetPoint(actionAjax, autocompletePointId);
					switchIcon(markersOnMap.get(autocompletePointId));
					$('#input-search').val("");
				}
			});
			//END Autocomplete for search input
        </script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC46e-kbgkWJWSVadj7q-K8LwVbc2Hp8hc&callback=initMap"></script>
    </body>
</html>